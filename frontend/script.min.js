const verseBox=document.getElementById("verse-box"),bookList=document.getElementById("book-list"),passageDisplay=document.getElementById("passage-display"),sortButton=document.getElementById("sort-button");let selectedBooks=new Set,currentVerse=null,apiBooks=[],canonicalOrder=[],alphabeticalOrder=[],sortAlphabetical=!1;const CANONICAL_IDS=["genesis","exodus","leviticus","numbers","deuteronomy","joshua","judges","ruth","1samuel","2samuel","1kings","2kings","1chronicles","2chronicles","ezra","nehemiah","esther","job","psalms","proverbs","ecclesiastes","songofsolomon","isaiah","jeremiah","lamentations","ezekiel","daniel","hosea","joel","amos","obadiah","jonah","micah","nahum","habakkuk","zephaniah","haggai","zechariah","malachi","matthew","mark","luke","john","acts","romans","1corinthians","2corinthians","galatians","ephesians","philippians","colossians","1thessalonians","2thessalonians","1timothy","2timothy","titus","philemon","hebrews","james","1peter","2peter","1john","2john","3john","jude","revelation"];async function init(){await fetchBooks(),fetchVerse(),setInterval(fetchVerse,3e5)}async function fetchBooks(){const e=await fetch("/api/books"),t=await e.json();apiBooks=t.map(e=>e.book);const o=new Set(apiBooks);canonicalOrder=CANONICAL_IDS.filter(e=>o.has(e)),alphabeticalOrder=[...apiBooks].sort((e,t)=>prettifyName(e).toLowerCase().localeCompare(prettifyName(t).toLowerCase())),updateSortButtonText(),renderBooks()}function renderBooks(){bookList.innerHTML="";(sortAlphabetical?alphabeticalOrder:canonicalOrder).forEach(e=>{const t=document.createElement("button");t.className="book-item",t.dataset.book=e;const o=document.createElement("span");o.className="dot",t.appendChild(o);const s=document.createElement("span");s.textContent=prettifyName(e),t.appendChild(s),t.addEventListener("click",()=>toggleBook(e,t)),selectedBooks.has(e)&&t.classList.add("selected"),bookList.appendChild(t)})}function toggleBook(e,t){selectedBooks.has(e)?(selectedBooks.delete(e),t.classList.remove("selected")):(selectedBooks.add(e),t.classList.add("selected"))}function selectAllBooks(){selectedBooks.clear();(sortAlphabetical?alphabeticalOrder:canonicalOrder).forEach(e=>selectedBooks.add(e)),renderBooks()}function clearBooks(){selectedBooks.clear(),renderBooks()}function toggleSort(){sortAlphabetical=!sortAlphabetical,updateSortButtonText();const e=document.querySelector(".sidebar"),t=e.scrollTop;renderBooks(),e.scrollTop=t}function updateSortButtonText(){sortButton.textContent=sortAlphabetical?"Sort: Alphabetical":"Sort: Original"}function prettifyName(e){let t=e.replace(/^(\d)([a-z])/,"$1 $2");return t=t.replace(/songofsolomon/i,"Song of Solomon"),t.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}async function fetchVerse(){const e=Array.from(selectedBooks),t=e.length?`?book=${e.join(",")}`:"",o=await fetch(`/api/verse${t}`),s=await o.json();s&&s.text?(verseBox.innerHTML=`${prettifyName(s.book)} ${s.chapter}:${s.verse} â€” ${s.text}`,currentVerse=s,passageDisplay.style.display="none"):(verseBox.textContent="Verse not found.",currentVerse=null)}async function openPassage(){if(!currentVerse)return;const{book:e,chapter:t,verse:o}=currentVerse,s=await fetch(`/api/passage?book=${e}&chapter=${t}&verse=${o}`),a=await s.json();if(a.error)return passageDisplay.textContent="Passage not found.",void(passageDisplay.style.display="block");let n=`<h2>${prettifyName(a.book)} ${a.chapter}</h2><p>`;const r={};a.verses.forEach(e=>{r[e.verse]||(r[e.verse]=[]),r[e.verse].push(e.text)}),Object.keys(r).forEach(e=>{const t=r[e].join(" ").trim(),o=parseInt(e,10)===a.highlight?`<span class="highlight" id="highlighted-verse"><sup>${e}</sup> ${t}</span>`:`<sup>${e}</sup> ${t}`;n+=`${o} `}),n+="</p>",passageDisplay.innerHTML=n,passageDisplay.style.display="block";const i=document.getElementById("highlighted-verse");i?i.scrollIntoView({behavior:"smooth",block:"center"}):passageDisplay.scrollTop=0}function toggleSidebar(){document.getElementById("sidebar").classList.toggle("collapsed")}init();